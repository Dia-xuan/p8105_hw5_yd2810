---
title: "p8105_hw5_yd2810"
author: "Yaxuan Deng"
date: "`r Sys.Date()`"
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(tidyverse)
library(broom)
library(purrr)
library(here)
```

## Problem 1

```{r}
set.seed(1234)

share_birthday <- function(n){
  birthday <- sample.int(365,size=n,replace = TRUE)
  any(duplicated(birthday))
}

n_seq <- 2:50
n_sim <- 10000

# simulate each n and estimate probability
simulation <- 
  map_dfr(n_seq,\(n){
    tibble(
      n=n,
      prob = mean(replicate(n_sim, share_birthday(n)))
    )
  })
```

```{r}
ggplot(simulation, aes(x = n, y = prob)) +
  geom_line(linewidth = 1) +
  geom_point(size = 1.2) +
  scale_y_continuous(labels = scales::percent_format(accuracy = 1)) +
  labs(x = "Group size (n)",
       y = "Probability of ‚â•2 shared birthdays") +
  theme_minimal(base_size = 12)
```
According to the plot, the probability of at least two people have shared birthdays reaches 50% at around a group size of 23, and exceeds 90% at around group size 41. The curve first rises at a slower rate for group size lower than 10, than has a tendency of increases faster as `n` increases until the probability becomes relatively large.

## Problem 2

```{r}
set.seed(4321)

n <- 30
sigma <- 5
n_sim <- 5000
mu_grid <- c(0,1:6)

sim_once <- function(mu){
  x <- rnorm(n, mean = mu, sd = sigma)
  tt <- t.test(x, mu = 0) %>% tidy()
  tibble(mu = mu,
         mu_hat = tt$estimate,
         p = tt$p.value,
         rej = tt$p.value < 0.05)
}

sim_tbl <- map_dfr(mu_grid, ~map_dfr(1:n_sim, \(.) sim_once(.x)))
```

```{r}
# plot 1
power_tbl <- sim_tbl %>% 
  group_by(mu) %>% 
  summarise(power = mean(rej), .groups = "drop")

ggplot(power_tbl, aes(mu, power))+
  geom_line()+ geom_point()+
  scale_y_continuous(labels = scales::percent_format()) +
  labs(x = "True mean (Œº)", y = "Power (Œ± = 0.05)")
```

 Power increases with the true mean Œº when n=`r n`, œÉ=`r sigma`. It is close to 0 when Œº=0, and approximately reaches 100% by Œº‚â•4. Larger effects make one-sample t-test rejects more often.

```{r}
avg_tbl <- sim_tbl %>% 
  group_by(mu) %>% 
  summarise(all = mean(mu_hat),
            rej_only = mean(mu_hat[rej]),
            .groups = "drop") %>% 
  pivot_longer(-mu, names_to = "set", values_to = "avg_mu_hat")

ggplot(avg_tbl, aes(mu, avg_mu_hat, color = set)) +
  geom_line()+ geom_point()+
  labs(x = "True mean (Œº)", y = "Average of ŒºÃÇ",
       color = NULL)
```


The sample average of estimated ùúá across tests for which the null is rejected is not approximately equal to the true value of ùúá when power is low. For small ùúá, the 'rej_only' line sits above the 'all' line, for conditioning of p<0.05 selects estimates that are farther from 0, creating selection bias and inflating estimation of ùúá. As ùúá grow (>=4) and power approaches 1,  the two lines coincide. 

## Problem 3

```{r}
homicide_raw <- read_csv(here("data", "homicide-data.csv"))
```

The raw data has `r nrow(homicide_raw)` observations and `r ncol(homicide_raw)` variables. Each row represents one homicide case from `r n_distinct(homicide_raw$city)` cities in `r n_distinct(homicide_raw$state)` states.

```{r}
data <- homicide_raw %>% 
  mutate(
    city_state = str_c(city,", ",state),
    unsolved   = disposition %in% c("Closed without arrest", "Open/No arrest")
  )
```

```{r}
city_homicide <- data %>% 
  count(city_state,unsolved,name="n") %>% 
  pivot_wider(names_from = unsolved,
              values_from = n, values_fill = 0) %>% 
  rename(solved = `FALSE`,unsolved=`TRUE`) %>% 
  mutate(total=solved+unsolved)
```

```{r}
bal <- city_homicide %>% filter(city_state=="Baltimore, MD")

bal_test <- prop.test(x=bal$unsolved,n=bal$total)
bal_tidy <- tidy(bal_test)
bal_tidy
```

```{r}
city_est <- city_homicide %>% 
  mutate(test = map2(unsolved, total, ~prop.test(.x, .y)),
         out = map(test, tidy)) %>% 
  unnest(out) %>% 
  select(city_state, total, unsolved, estimate, conf.low, conf.high, p.value)
```

```{r}
city_est %>% 
  mutate(city_state=fct_reorder(city_state,estimate)) %>% 
  ggplot(aes(x = city_state, y = estimate))+
  geom_point()+
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high),width=0)+
                  coord_flip()+
                  labs(x = NULL, y = "Proportion unsolved",
       title = "Homicide unsolved proportions by city")+
         theme_minimal(base_size = 12)
```

